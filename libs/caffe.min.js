var __extends=this&&this.__extends||function(t,i){function e(){this.constructor=t}for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s]);t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)},NumJS;!function(t){function i(i,e){return void 0===e&&(e=t.DEFAULT_TYPE_INSTANCE),new e(i)}function e(t,i){for(var e=0,s=t.length;e<s;++e)t[e]=i;return t}function s(t){for(var i=1,e=0,s=t.length;e<s;++e)i*=t[e];return i}function r(t){for(var i=0,e=0,s=t.length;e<s;++e)i+=t[e];return i}function o(t,i){if(t.length===i.length){for(var e=0,s=t.length;e<s;++e)t[e]+=i[e];return t}throw"Bad input shape"}function n(t,i){for(var e=0,s=t.length;e<s;++e)t[e]+=i;return t}function a(t,i){if(t.length===i.length){for(var e=0,s=t.length;e<s;++e)t[e]-=i[e];return t}throw"Bad input shape"}function h(t,i){for(var e=0,s=t.length;e<s;++e)t[e]-=i;return t}function u(t,i){if(t.length===i.length){for(var e=0,s=t.length;e<s;++e)t[e]*=i[e];return t}throw"Bad input shape"}function p(t,i){for(var e=0,s=t.length;e<s;++e)t[e]*=i;return t}function d(t,i){if(t.length===i.length){for(var e=0,s=t.length;e<s;++e)t[e]/=i[e];return t}throw"Bad input shape"}function _(t,i){for(var e=0,s=t.length;e<s;++e)t[e]/=i;return t}function c(t,i,e){if(t.length===i.length){for(var s=0,r=t.length;s<r;++s)t[s]+=e*i[s];return t}throw"Bad input shape"}t.DEFAULT_TYPE_INSTANCE=Float32Array,t.zeros=i,t.fill=e,t.prod=s,t.sum=r,t.add=o,t.addConst=n,t.sub=a,t.subConst=h,t.mul=u,t.mulByConst=p,t.div=d,t.divByConst=_,t.addScaled=c}(NumJS||(NumJS={}));var NumJS;!function(t){function i(t){for(var i=Number.NEGATIVE_INFINITY,e=0,s=t.length;e<s;++e)t[e]>i&&(i=t[e]);return i}function e(t){for(var i=Number.NEGATIVE_INFINITY,e=0,s=0,r=t.length;s<r;++s)t[s]>i&&(i=t[s],e=s);return e}function s(t,i){return i=i||3,t.sort(function(t,i){return i-t}).slice(0,i)}function r(t,i){i=i||3;for(var e=t.length,s=new Uint32Array(e),r=0;r<e;++r)s[r]=r;return s.sort(function(i,e){return t[e]-t[i]}).slice(0,i)}function o(t){if(0===t.length)return{};for(var i=t[0],e=t[0],s=0,r=0,o=1,n=t.length;o<n;++o)t[o]>i&&(i=t[o],s=o),t[o]<e&&(e=t[o],r=o);return{maxi:s,maxv:i,mini:r,minv:e,dv:i-e}}t.max=i,t.argmax=e,t.maxn=s,t.argmaxn=r,t.maxmin=o}(NumJS||(NumJS={}));var NumJS;!function(t){function i(){if(n)return n=!1,a;var t=2*Math.random()-1,e=2*Math.random()-1,s=t*t+e*e;if(0==s||s>1)return i();var r=Math.sqrt(-2*Math.log(s)/s);return a=e*r,n=!0,t*r}function e(t,i){return Math.random()*(i-t)+t}function s(t,i){return Math.floor(Math.random()*(i-t)+t)}function r(t,e){return t+i()*e}function o(t){for(var i,e=t,s=0,r=[],o=0;o<t;++o)r[o]=o;for(;e--;)s=Math.floor(Math.random()*(e+1)),i=r[e],r[e]=r[s],r[s]=i;return r}var n=!1,a=0;t.gaussRandom=i,t.randf=e,t.randi=s,t.randn=r,t.randperm=o}(NumJS||(NumJS={}));var NumJS;!function(t){function i(t,i,e){return Math.max(Math.min(t,e),i)}function e(t,i){return(t%i+i)%i}function s(t){var i=Math.exp(2*t);return(i-1)/(i+1)}t.clip=i,t.mod=e,t.tanh=s}(NumJS||(NumJS={}));var Parser;!function(t){var i=function(){function t(){}return t.prototype.fetch=function(t){var i=new Request(t);return fetch(i).then(function(t){return t.text()})},t.prototype.parse=function(t){var i=this;return this.fetch(t).then(function(t){return i.parseString(t)})},t}();t.BaseParser=i}(Parser||(Parser={}));var Parser;!function(t){var i=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.parseString=function(t){return this.parsePrototxt(t)},i.prototype.parsePrototxt=function(t,i){void 0===i&&(i=0);var e,s={};if(0==i)var r=/(?:^|\n)(\w+):\s"*([\w\/.]+)"*/gi,o=/(?:^|\n)(\w+)\s\{([\S\s]*?)\n\}/gi;else var n="(?:^|\\n)\\s{"+i+"}",a="(\\w+)",r=new RegExp(n+a+'\\s*:\\s*"*([\\w/.]+)"*',"gi"),o=new RegExp(n+a+"\\s*\\{\\s*\\n([\\s\\S]*?)\\n\\s{"+i+"}\\}","gi");for(;e=r.exec(t);){var a=e[1],h=e[2];void 0!==s[a]?Array.isArray(s[a])?s[a].push(h):(s[a]=[s[a]],s[a].push(h)):s[e[1]]=h}for(;e=o.exec(t);){var a=e[1],h=this.parsePrototxt(e[2],i+2);void 0!==s[a]?Array.isArray(s[a])?s[a].push(h):(s[a]=[s[a]],s[a].push(h)):s[a]=h}return s},i}(t.BaseParser);t.PrototxtParser=i}(Parser||(Parser={}));var Net;!function(t){var i=NumJS,e=function(){function t(t,e,s,r){this.sx=t,this.sy=e,this.depth=s;var o=this.sx*this.sy*this.depth;if(this.w=i.zeros(o),this.dw=i.zeros(o),void 0===r)for(var n=Math.sqrt(1/o),a=0;a<o;++a)this.w[a]=i.randn(0,n);else 0!==r&&i.fill(this.w,r)}return t.fromArray=function(i){var e=new t(1,1,i.length,0);return e.w.set(i),e},t.prototype.clone=function(){var i=new t(this.sx,this.sy,this.depth,0);return i.w.set(this.w),i},t.prototype.cloneAndZero=function(){var i=new t(this.sx,this.sy,this.depth,0);return i},t.prototype.get=function(t,i,e){var s=(this.sx*i+t)*this.depth+e;return this.w[s]},t.prototype.set=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;this.w[r]=s},t.prototype.add=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;return this.w[r]+=s,this},t.prototype.sub=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;return this.w[r]-=s,this},t.prototype.mul=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;return this.w[r]*=s,this},t.prototype.div=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;return this.w[r]/=s,this},t.prototype.get_grad=function(t,i,e){var s=(this.sx*i+t)*this.depth+e;return this.dw[s]},t.prototype.set_grad=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;this.dw[r]=s},t.prototype.add_grad=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;this.dw[r]+=s},t.prototype.sub_grad=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;this.dw[r]-=s},t.prototype.mul_grad=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;this.dw[r]*=s},t.prototype.div_grad=function(t,i,e,s){var r=(this.sx*i+t)*this.depth+e;this.dw[r]/=s},t.prototype.roll=function(t,e,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===s&&(s=0);for(var r=this.clone(),o=0,n=r.depth;o<n;++o)for(var a=0,h=r.sx;a<h;++a)for(var u=0,p=r.sy;u<p;++u){var d=this.get(i.mod(a+t,this.sx),i.mod(u+e,this.sy),i.mod(o+s,this.depth));r.set(a,u,o,d)}return r},t.prototype.zoom=function(i,e,s){void 0===i&&(i=1),void 0===e&&(e=1),void 0===s&&(s=1);for(var r=new t(Math.round(this.sx*i),Math.round(this.sy*e),Math.round(this.depth*s),0),o=0,n=r.depth;o<n;++o)for(var a=0,h=r.sx;a<h;++a)for(var u=0,p=r.sy;u<p;++u){for(var d=0,_=Math.ceil(1/i),c=Math.ceil(1/e),f=Math.ceil(1/s),l=Math.ceil(a/i),y=Math.ceil(u/e),v=Math.ceil(o/s),m=Math.min(l+_,this.sx),w=Math.min(y+c,this.sy),g=Math.min(v+f,this.depth),x=l;x<m;x++)for(var N=y;N<w;N++)for(var S=v;S<g;S++){var b=this.get(x,N,S);r.add(a,u,o,b),d++}r.div(a,u,o,d)}return r},t.prototype.toJSON=function(){var t={};return t.sx=this.sx,t.sy=this.sy,t.depth=this.depth,t.w=this.w,t},t.fromJSON=function(i){var e=new t(i.sx,i.sy,i.depth,0);return e.w.set(i.w),e},t}();t.Vol=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(){function t(){}return t.prototype.setInputDimensions=function(t,i,e){void 0===e&&(e=3),this.layerIterator(function(s,r,o){0===r?(s.in_sx=t,s.in_sy=i,s.in_depth=e,s.updateDimensions()):s.updateDimensions(o)})},t.prototype.layerIterator=function(t,i){var e=this;void 0===i&&(i={});var s,r=[],o=[],n=0,a=d3.set();void 0===i.reverse||i.reverse===!1?(s=i.start?this.layers.get(i.start):this.layers.get("data"),o=this.edges):(s=i.start?this.layers.get(i.start):this.layers.values()[this.layers.size()-1],o=this.edges.map(function(t){return{from:t.to,to:t.from}}));var h=d3.map(d3.nest().key(function(t){return t.from}).entries(o),function(t){return t.key}),u=d3.map(d3.nest().key(function(t){return t.to}).entries(o),function(t){return t.key});for(r.push(s);r.length;){var p=r.pop();a.add(p.name);var d=u.get(p.name),_=void 0===d?void 0:d.values.map(function(t){return e.layers.get(t.from)});if(t(p,n++,_),i.end&&p.name===i.end)break;var c=h.get(p.name);c&&c.values.filter(function(t){return!a.has(t.to)}).forEach(function(t){var i=u.get(t.to),s=void 0===i?[]:i.values.filter(function(t){return!a.has(t.from)});0===s.length&&r.push(e.layers.get(t.to))})}},t.prototype.forward=function(t,i,e){void 0===i&&(i=!1),void 0===e&&(e={});var s,r=d3.map();return this.layerIterator(function(e,o,n){s=void 0===n?t:n.length>1?n.map(function(t){return r.get(t.name)}):r.get(n[0].name),s=e.forward(s,i),r.set(e.name,s)},e),s},t.prototype.backward=function(t,i){void 0===i&&(i={}),i.reverse=!0;var e;return this.layerIterator(function(i,s,r){void 0!==t&&0===s?e=i.backward(t):i.backward()},i),e},t.prototype.debugStructure=function(){var t=0,e=d3.format("s"),s=d3.format(",d"),r=0;this.layerIterator(function(e,o,n){var a=i.sum(e.getNumParameters()),h="";h+=e.getOutputShape().join("x")+" :: ",h+=e.getDescription().join(" "),a&&(t+=a,h+=" => "+s(a)+" parameters"),r+=1,console.log(h)}),console.log("---"),console.log("Total number of layers "+s(r)),console.log("Total number of params "+s(t)+" (memory: "+e(4*t)+"b): ")},t}();t.Net=e}(Net||(Net={}));var Net;!function(t){function i(t,i){for(var e=n.randf(0,1),s=0,r=0,o=t.length;r<o;r++)if(s+=i[r],e<s)return t[r]}function e(t,i,e){if(void 0===t&&(t={}),"string"==typeof i)return void 0!==t[i]?t[i]:e;var s=e;return i.forEach(function(i){s=void 0!==t[i]?t[i]:s}),s}function s(t,i){if(!t){if(i=i||"Assertion failed","undefined"!=typeof Error)throw new Error(i);throw i}}function r(t,i){for(var e=0,s=t.length;e<s;e++)if(t[e]===i)return!0;return!1}function o(t){for(var i=[],e=0,s=t.length;e<s;e++)r(i,t[e])||i.push(t[e]);return i}var n=NumJS;t.weightedSample=i,t.getopt=e,t.assert=s,t.arrContains=r,t.arrUnique=o}(Net||(Net={}));var Net;!function(t){var i=function(){function t(t){this.in_depth=1,this.in_sy=1,this.in_sx=1,this.out_depth=1,this.out_sy=1,this.out_sx=1,this.name=void 0!==t.name?t.name:"",this.input=void 0!==t.input?t.input:void 0,this.output=void 0!==t.output?t.output:void 0,t.pred||(this.in_sx=t.in_sx,this.in_sy=t.in_sy,this.in_depth=t.in_depth)}return t.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.out_sx=this.in_sx,this.out_sy=this.in_sy,this.out_depth=this.in_depth},t.prototype.getNumParameters=function(){return[0,0]},t.prototype.getOutputShape=function(){return[this.in_depth,this.in_sy,this.in_sx]},t.prototype.getDescription=function(){return[this.layer_type.toUpperCase(),this.name]},t.prototype.getParamsAndGrads=function(){return[]},t.prototype.toJSON=function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.name=this.name,t.output=this.output,t.input=this.input,t},t.prototype.fromJSON=function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.name=t.name,this.output=t.output,this.input=t.input},t}();t.BaseLayer=i}(Net||(Net={}));var Net;!function(t){var i=function(i){function e(e){i.call(this,e||{}),this.layer_type="input",this.in_depth=t.getopt(e,["in_depth","out_depth","depth"],0),this.in_sx=t.getopt(e,["in_sx","out_sx","sx","width"],1),this.in_sy=t.getopt(e,["in_sy","out_sy","sy","height"],1),this.updateDimensions()}return __extends(e,i),e.prototype.forward=function(t,i){return this.in_act=t,this.out_act=t,this.out_act},e.prototype.backward=function(){},e}(t.BaseLayer);t.InputLayer=i}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(i){e.call(this,i||{}),this.layer_type="concat",this.axis=t.getopt(i,["axis"],1),this.updateDimensions(i.pred)}return __extends(s,e),s.prototype.forward=function(i,e){this.in_act=i;var s=new t.Vol(this.out_sx,this.out_sy,this.out_depth,0),r=0;if(0===this.axis)for(var o=s.w,n=0;n<i.length;n++)o.set(i[n].w,r),r+=i[n].w.length;else for(var n=0;n<i.length;n++){for(var a=i[n],h=0;h<a.depth;h++)for(var u=0;u<a.sx;u++)for(var p=0;p<a.sy;p++)s.set(u,p,h+r,a.get(u,p,h));r+=a.depth}return this.out_act=s,this.out_act},s.prototype.backward=function(){var t=this.in_act,i=this.out_act,e=0;if(0===this.axis)for(var s=i.dw,r=0,o=t.length;r<o;++r){var n=t[r].dw;s.set(n,e),e+=n.length}else for(var r=0,o=t.length;r<o;++r){for(var a=t[r],h=0,u=a.depth;h<u;++h)for(var p=0,d=a.sx;p<d;++p)for(var _=0,c=a.sy;_<c;++_)a.set_grad(p,_,h,i.get_grad(p,_,h+e));e+=a.depth}},s.prototype.updateDimensions=function(t){t&&(0==this.axis?(this.in_sx=t[0].in_sx,this.in_sy=t[0].in_sy,this.in_depth=t[0].in_depth):(this.in_sx=t[0].in_sx,this.in_sy=t[0].in_sy,this.in_depth=i.sum(t.map(function(t){return t.out_depth})))),this.out_sx=this.in_sx,this.out_sy=this.in_sy,this.out_depth=this.in_depth},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.axis=this.axis,t},s.prototype.fromJSON=function(t){e.prototype.fromJSON.call(this,t),this.axis=t.axis},s}(t.BaseLayer);t.ConcatLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(i){e.call(this,i||{}),this.layer_type="conv",this.out_depth=i.filters,this.sx=i.sx,this.sy=t.getopt(i,["sy"],this.sx),this.stride=t.getopt(i,["stride"],1),this.pad=t.getopt(i,["pad"],0),this.l1_decay_mul=t.getopt(i,["l1_decay_mul"],0),this.l2_decay_mul=t.getopt(i,["l2_decay_mul"],1),this.updateDimensions(i.pred);var s=t.getopt(i,["bias_pref"],0);this.biases=new t.Vol(1,1,this.out_depth,s),this.filters=[];for(var r=0;r<this.out_depth;++r)this.filters.push(new t.Vol(this.sx,this.sy,this.in_depth,0))}return __extends(s,e),s.prototype.forward=function(i,e){this.in_act=i;for(var s=new t.Vol(0|this.out_sx,0|this.out_sy,0|this.out_depth,0),r=0|i.sx,o=0|i.sy,n=0|this.stride,a=0;a<this.out_depth;++a)for(var h=this.filters[a],u=0|-this.pad,p=0|-this.pad,d=0;d<this.out_sy;p+=n,++d){u=0|-this.pad;for(var _=0;_<this.out_sx;u+=n,++_){for(var c=0,f=0;f<h.sy;++f)for(var l=p+f,y=0;y<h.sx;++y){var v=u+y;if(l>=0&&l<o&&v>=0&&v<r)for(var m=0;m<h.depth;++m)c+=h.w[(h.sx*f+y)*h.depth+m]*i.w[(r*l+v)*i.depth+m]}c+=this.biases.w[a],s.set(_,d,a,c)}}return this.out_act=s,this.out_act},s.prototype.backward=function(){var t=this.in_act;t.dw=i.zeros(t.w.length);for(var e=0|t.sx,s=0|t.sy,r=0|this.stride,o=0;o<this.out_depth;++o)for(var n=this.filters[o],a=0|-this.pad,h=0|-this.pad,u=0;u<this.out_sy;h+=r,++u){a=0|-this.pad;for(var p=0;p<this.out_sx;a+=r,++p){for(var d=this.out_act.get_grad(p,u,o),_=0;_<n.sy;++_)for(var c=h+_,f=0;f<n.sx;++f){var l=a+f;if(c>=0&&c<s&&l>=0&&l<e)for(var y=0;y<n.depth;++y){var v=(e*c+l)*t.depth+y,m=(n.sx*_+f)*n.depth+y;n.dw[m]+=t.w[v]*d,t.dw[v]+=n.w[m]*d}}this.biases.dw[o]+=d}}},s.prototype.getParamsAndGrads=function(){for(var t=[],i=0;i<this.out_depth;i++)t.push({params:this.filters[i].w,grads:this.filters[i].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0}),t},s.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.out_sx=Math.round((this.in_sx+2*this.pad-this.sx)/this.stride+1),this.out_sy=Math.round((this.in_sy+2*this.pad-this.sy)/this.stride+1)},s.prototype.getNumParameters=function(){return[this.in_depth*this.sx*this.sy*this.out_depth,this.out_depth]},s.prototype.getOutputShape=function(){return[this.out_depth,Math.ceil((this.in_sy+2*this.pad-this.sy+1+this.stride-1)/this.stride),Math.ceil((this.in_sx+2*this.pad-this.sx+1+this.stride-1)/this.stride)]},s.prototype.getDescription=function(){return e.prototype.getDescription.call(this).concat([[this.out_depth,this.sy,this.sx].join("x")+" Stride "+this.stride+" Pad "+this.pad])},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.in_depth=this.in_depth,t.l1_decay_mul=this.l1_decay_mul,t.l2_decay_mul=this.l2_decay_mul,t.pad=this.pad,t.filters=[];for(var i=0;i<this.filters.length;i++)t.filters.push(this.filters[i].toJSON());return t.biases=this.biases.toJSON(),t},s.prototype.fromJSON=function(i){e.prototype.fromJSON.call(this,i),this.sx=i.sx,this.sy=i.sy,this.stride=i.stride,this.in_depth=i.in_depth,this.filters=[],this.l1_decay_mul=void 0!==i.l1_decay_mul?i.l1_decay_mul:0,this.l2_decay_mul=void 0!==i.l2_decay_mul?i.l2_decay_mul:1,this.pad=void 0!==i.pad?i.pad:0;for(var s=0;s<i.filters.length;s++)this.filters.push(t.Vol.fromJSON(i.filters[s]));this.biases=t.Vol.fromJSON(i.biases)},s}(t.BaseLayer);t.ConvLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(i){e.call(this,i||{}),this.layer_type="pool",this.out_depth=i.filters,this.sx=i.sx,this.pool=t.getopt(i,["pool"],"MAX"),this.sy=t.getopt(i,["sy"],this.sx),this.stride=t.getopt(i,["stride"],1),this.pad=t.getopt(i,["pad"],0),this.updateDimensions(i.pred)}return __extends(s,e),s.prototype.forward=function(e,s){this.in_act=e,this.switchx=i.zeros(this.out_sx*this.out_sy*this.out_depth),this.switchy=i.zeros(this.out_sx*this.out_sy*this.out_depth);var r=new t.Vol(this.out_sx,this.out_sy,this.out_depth,0);if("AVE"===this.pool)for(var o=(this.sx*this.sy,0);o<this.out_depth;++o)for(var n=0;n<this.out_sx;++n)for(var a=0;a<this.out_sy;++a){for(var h=0,u=n*this.stride-this.pad,p=a*this.stride-this.pad,d=Math.min(u+this.sx,this.out_sx+this.pad),_=Math.min(p+this.sy,this.out_sy+this.pad),c=(d-u)*(_-p),f=u;f<d;++f)for(var l=p;l<_;++l)h+=e.get(f,l,o);r.set(n,a,o,h/c)}else for(var y=0,v=0;v<this.out_depth;++v)for(var m=-this.pad,w=-this.pad,g=0;g<this.out_sx;m+=this.stride,g++){w=-this.pad;for(var x=0;x<this.out_sy;w+=this.stride,x++){for(var N=-99999,S=-1,b=-1,J=0;J<this.sx;++J)for(var O=0;O<this.sy;++O){var L=w+O,M=m+J;if(L>=0&&L<e.sy&&M>=0&&M<e.sx){var k=e.get(M,L,v);k>N&&(N=k,S=M,b=L)}}this.switchx[y]=S,this.switchy[y]=b,y++,r.set(g,x,v,N)}}return this.out_act=r,this.out_act},s.prototype.backward=function(){var t=this.in_act;t.dw=i.zeros(t.w.length);this.out_act;if("AVE"===this.pool);else for(var e=0,s=0;s<this.out_depth;++s)for(var r=-this.pad,o=0;o<this.out_sx;r+=this.stride,o++)for(var n=-this.pad,a=0;a<this.out_sy;n+=this.stride,a++){var h=this.out_act.get_grad(o,a,s);t.add_grad(this.switchx[e],this.switchy[e],s,h),e++}},s.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.out_sx=Math.round((this.in_sx+2*this.pad-this.sx)/this.stride+1),this.out_sy=Math.round((this.in_sy+2*this.pad-this.sy)/this.stride+1),this.out_depth=this.in_depth},s.prototype.getDescription=function(){return[this.pool+" "+this.layer_type.toUpperCase(),this.name,[this.sy,this.sx].join("x")+" Stride "+this.stride+" Pad "+this.pad]},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.pool=this.pool,t.in_depth=this.in_depth,t.pad=this.pad,t},s.prototype.fromJSON=function(t){e.prototype.fromJSON.call(this,t),this.pool=void 0!==t.pool?t.pool:"MAX",this.sx=t.sx,this.sy=t.sy,this.stride=t.stride,this.in_depth=t.in_depth,this.pad=void 0!==t.pad?t.pad:0,this.switchx=i.zeros(this.out_sx*this.out_sy*this.out_depth,Uint32Array),this.switchy=i.zeros(this.out_sx*this.out_sy*this.out_depth,Uint32Array)},s}(t.BaseLayer);t.PoolLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(i){e.call(this,i||{}),this.layer_type="fc",this.out_depth=void 0!==i.num_neurons?i.num_neurons:i.filters,this.l1_decay_mul=t.getopt(i,["l1_decay_mul"],0),this.l2_decay_mul=t.getopt(i,["l2_decay_mul"],1),this.updateDimensions(i.pred);var s=t.getopt(i,["bias_pref"],0);this.biases=new t.Vol(1,1,this.out_depth,s),this.filters=[];for(var r=0;r<this.out_depth;++r)this.filters.push(new t.Vol(1,1,this.num_inputs,0));if(void 0!==i.filters)for(var r=0;r<this.out_depth;++r)this.filters[r].w.set(i.filters[r]);void 0!==i.biases&&this.biases.w.set(i.biases)}return __extends(s,e),s.prototype.forward=function(i,e){this.in_act=i;for(var s=new t.Vol(1,1,this.out_depth,0),r=i.w,o=0;o<this.out_depth;++o){for(var n=0,a=this.filters[o].w,h=0;h<this.num_inputs;++h)n+=r[h]*a[h];n+=this.biases.w[o],s.w[o]=n}return this.out_act=s,this.out_act},s.prototype.backward=function(){var t=this.in_act;t.dw=i.zeros(t.w.length);for(var e=0;e<this.out_depth;++e){for(var s=this.filters[e],r=this.out_act.dw[e],o=0;o<this.num_inputs;++o)t.dw[o]+=s.w[o]*r,s.dw[o]+=t.w[o]*r;this.biases.dw[e]+=r}},s.prototype.getParamsAndGrads=function(){for(var t=[],i=0;i<this.out_depth;++i)t.push({params:this.filters[i].w,grads:this.filters[i].dw,l1_decay_mul:this.l1_decay_mul,l2_decay_mul:this.l2_decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0}),t},s.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth},s.prototype.getNumParameters=function(){return[this.in_depth*this.in_sx*this.in_sy*this.out_depth,this.out_depth]},s.prototype.getOutputShape=function(){return[this.out_depth,1,1]},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);t.num_inputs=this.num_inputs,t.l1_decay_mul=this.l1_decay_mul,t.l2_decay_mul=this.l2_decay_mul,t.filters=[];for(var i=0;i<this.filters.length;i++)t.filters.push(this.filters[i].toJSON());return t.biases=this.biases.toJSON(),t},s.prototype.fromJSON=function(i){e.prototype.fromJSON.call(this,i),this.num_inputs=i.num_inputs,this.l1_decay_mul=void 0!==i.l1_decay_mul?i.l1_decay_mul:1,this.l2_decay_mul=void 0!==i.l2_decay_mul?i.l2_decay_mul:1,this.filters=[];for(var s=0;s<i.filters.length;s++)this.filters.push(t.Vol.fromJSON(i.filters[s]));this.biases=t.Vol.fromJSON(i.biases)},s}(t.BaseLayer);t.FullyConnectedLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(i){e.call(this,i||{}),this.layer_type="dropout",this.drop_prob=t.getopt(i,["drop_prob"],.5),this.updateDimensions(i.pred)}return __extends(s,e),s.prototype.forward=function(t,e){void 0===e&&(e=!1),this.in_act=t,this.dropped=i.zeros(this.out_sx*this.out_sy*this.out_depth,Int8Array);var s=t.clone(),r=t.w.length;if(e)for(var o=0;o<r;o++)Math.random()<this.drop_prob&&(s.w[o]=0,this.dropped[o]=1);else for(var o=0;o<r;o++)s.w[o]*=this.drop_prob;return this.out_act=s,this.out_act},s.prototype.backward=function(){var t=this.in_act,e=this.out_act,s=t.w.length;t.dw=i.zeros(s);for(var r=0;r<s;r++)1!==this.dropped[r]&&(t.dw[r]=e.dw[r])},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.drop_prob=this.drop_prob,t},s.prototype.fromJSON=function(t){e.prototype.fromJSON.call(this,t),this.drop_prob=t.drop_prob},s}(t.BaseLayer);t.DropoutLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(t){function e(i){t.call(this,i||{}),this.layer_type="tanh",this.updateDimensions(i.pred)}return __extends(e,t),e.prototype.forward=function(t,e){this.in_act=t;for(var s=t.cloneAndZero(),r=t.w.length,o=0;o<r;o++)s.w[o]=i.tanh(t.w[o]);return this.out_act=s,this.out_act},e.prototype.backward=function(){var t=this.in_act,e=this.out_act,s=t.w.length;t.dw=i.zeros(s);for(var r=0;r<s;r++){var o=e.w[r];t.dw[r]=(1-o*o)*e.dw[r]}},e}(t.BaseLayer);t.TanhLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(t){e.call(this,t||{}),this.layer_type="maxout",this.group_size=void 0!==t.group_size?t.group_size:2,this.updateDimensions(t.pred)}return __extends(s,e),s.prototype.forward=function(e,s){this.in_act=e,this.switches=i.zeros(this.out_sx*this.out_sy*this.out_depth,Uint32Array);var r=this.out_depth,o=new t.Vol(this.out_sx,this.out_sy,this.out_depth,0);if(1===this.out_sx&&1===this.out_sy)for(var n=0;n<r;n++){for(var a=n*this.group_size,h=e.w[a],u=0,p=1;p<this.group_size;p++){var d=e.w[a+p];d>h&&(h=d,u=p)}o.w[n]=h,this.switches[n]=a+u}else for(var _=0,c=0;c<e.sx;c++)for(var f=0;f<e.sy;f++)for(var n=0;n<r;n++){for(var a=n*this.group_size,h=e.get(c,f,a),u=0,p=1;p<this.group_size;p++){var d=e.get(c,f,a+p);d>h&&(h=d,u=p)}o.set(c,f,n,h),this.switches[_]=a+u,_++}return this.out_act=o,this.out_act},s.prototype.backward=function(){var t=this.in_act,e=this.out_act,s=this.out_depth;if(t.dw=i.zeros(t.w.length),1===this.out_sx&&1===this.out_sy)for(var r=0;r<s;r++){var o=e.dw[r];t.dw[this.switches[r]]=o}else for(var n=0,a=0;a<e.sx;a++)for(var h=0;h<e.sy;h++)for(var r=0;r<s;r++){var o=e.get_grad(a,h,r);t.set_grad(a,h,this.switches[n],o),n++}},s.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.out_sx=this.in_sx,this.out_sy=this.in_sy,this.out_depth=Math.floor(this.in_depth/this.group_size)},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.group_size=this.group_size,t},s.prototype.fromJSON=function(t){e.prototype.fromJSON.call(this,t),this.group_size=t.group_size},s}(t.BaseLayer);t.MaxoutLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(t){function e(i){t.call(this,i||{}),this.layer_type="relu",this.updateDimensions(i.pred)}return __extends(e,t),e.prototype.forward=function(t,i){this.in_act=t;for(var e=t.clone(),s=t.w.length,r=e.w,o=0;o<s;o++)r[o]<0&&(r[o]=0);return this.out_act=e,this.out_act},e.prototype.backward=function(){var t=this.in_act,e=this.out_act,s=t.w.length;t.dw=i.zeros(s);for(var r=0;r<s;r++)e.w[r]<=0?t.dw[r]=0:t.dw[r]=e.dw[r]},e}(t.BaseLayer);t.ReluLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(t){function e(i){t.call(this,i||{}),this.layer_type="sigmoid",this.updateDimensions(i.pred)}return __extends(e,t),e.prototype.forward=function(t,i){this.in_act=t;for(var e=t.cloneAndZero(),s=t.w.length,r=e.w,o=t.w,n=0;n<s;n++)r[n]=1/(1+Math.exp(-o[n]));return this.out_act=e,this.out_act},e.prototype.backward=function(){var t=this.in_act,e=this.out_act,s=t.w.length;t.dw=i.zeros(s);for(var r=0;r<s;r++){var o=e.w[r];t.dw[r]=o*(1-o)*e.dw[r]}},e}(t.BaseLayer);t.SigmoidLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(t){function e(i){t.call(this,i||{}),this.layer_type="regression",this.updateDimensions(i.pred)}return __extends(e,t),e.prototype.forward=function(t,i){return this.in_act=t,this.out_act=t,t},e.prototype.backward=function(t){var e=this.in_act;e.dw=i.zeros(e.w.length);var s=0;if(t instanceof Float32Array)for(var r=0;r<this.out_depth;r++){var o=e.w[r]-t[r];e.dw[r]=o,s+=.5*o*o}else if("number"==typeof t){var o=e.w[0]-t;e.dw[0]=o,s+=.5*o*o}else{var r=t.dim,n=t.val,o=e.w[r]-n;e.dw[r]=o,s+=.5*o*o}return s},e.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth,this.out_depth=this.num_inputs},e.prototype.getOutputShape=function(){return[this.out_depth,1,1]},e.prototype.toJSON=function(){var i=t.prototype.toJSON.call(this);return i.num_inputs=this.num_inputs,i},e.prototype.fromJSON=function(i){t.prototype.fromJSON.call(this,i),this.num_inputs=i.num_inputs},e}(t.BaseLayer);t.RegressionLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(e){function s(t){e.call(this,t||{}),this.layer_type="softmax",this.updateDimensions(t.pred)}return __extends(s,e),s.prototype.forward=function(e,s){this.in_act=e;for(var r=new t.Vol(1,1,this.out_depth,0),o=e.w,n=e.w[0],a=1;a<this.out_depth;a++)o[a]>n&&(n=o[a]);for(var h=i.zeros(this.out_depth),u=0,a=0;a<this.out_depth;a++){var p=Math.exp(o[a]-n);u+=p,h[a]=p}for(var a=0;a<this.out_depth;a++)h[a]/=u,r.w[a]=h[a];return this.es=h,this.out_act=r,this.out_act},s.prototype.backward=function(t){var e=this.in_act;e.dw=i.zeros(e.w.length);for(var s=0;s<this.out_depth;s++){var r=s===t?1:0,o=-(r-this.es[s]);e.dw[s]=o}return-Math.log(this.es[t])},s.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth,this.out_depth=this.num_inputs},s.prototype.getOutputShape=function(){return[this.out_depth,1,1]},s.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.num_inputs=this.num_inputs,t},s.prototype.fromJSON=function(t){e.prototype.fromJSON.call(this,t),this.num_inputs=t.num_inputs},s}(t.BaseLayer);t.SoftmaxLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(t){function e(i){t.call(this,i||{}),this.layer_type="svm",this.updateDimensions(i.pred)}return __extends(e,t),e.prototype.forward=function(t,i){return this.in_act=t,this.out_act=t,t},e.prototype.backward=function(t){var e=this.in_act;e.dw=i.zeros(e.w.length);for(var s=e.w[t],r=1,o=0,n=0;n<this.out_depth;n++)if(t!==n){var a=-s+e.w[n]+r;a>0&&(e.dw[n]+=1,e.dw[t]-=1,o+=a)}return o},e.prototype.updateDimensions=function(t){t&&(this.in_sx=t.out_sx,this.in_sy=t.out_sy,this.in_depth=t.out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth,this.out_depth=this.num_inputs},e.prototype.getOutputShape=function(){return[this.out_depth,1,1]},e.prototype.toJSON=function(){var i=t.prototype.toJSON.call(this);return i.num_inputs=this.num_inputs,i},e.prototype.fromJSON=function(i){t.prototype.fromJSON.call(this,i),this.num_inputs=i.num_inputs},e}(t.BaseLayer);t.SVMLayer=e}(Net||(Net={}));var Net;!function(t){var i=NumJS,e=function(t){function e(i){t.call(this,i||{}),this.layer_type="lrn",this.k=i.k,this.n=i.n,this.alpha=i.alpha,this.beta=i.beta,this.n%2===0&&console.warn("WARNING n should be odd for LRN layer"),this.updateDimensions(i.pred)}return __extends(e,t),e.prototype.forward=function(t,i){this.in_act=t;var e=t.cloneAndZero();this.S_cache_=t.cloneAndZero();for(var s=Math.floor(this.n/2),r=0;r<t.sx;r++)for(var o=0;o<t.sy;o++)for(var n=0;n<t.depth;n++){for(var a=t.get(r,o,n),h=0,u=Math.max(0,n-s);u<=Math.min(n+s,t.depth-1);u++){var p=t.get(r,o,u);h+=p*p}h*=this.alpha/this.n,h+=this.k,this.S_cache_.set(r,o,n,h),h=Math.pow(h,this.beta),e.set(r,o,n,a/h)}return this.out_act=e,this.out_act},e.prototype.backward=function(){var t=this.in_act;t.dw=i.zeros(t.w.length);for(var e=(this.out_act,Math.floor(this.n/2)),s=0;s<t.sx;s++)for(var r=0;r<t.sy;r++)for(var o=0;o<t.depth;o++)for(var n=this.out_act.get_grad(s,r,o),a=this.S_cache_.get(s,r,o),h=Math.pow(a,this.beta),u=h*h,p=Math.max(0,o-e);p<=Math.min(o+e,t.depth-1);p++){var d=t.get(s,r,p),_=-d*this.beta*Math.pow(a,this.beta-1)*this.alpha/this.n*2*d;p===o&&(_+=h),_/=u,_*=n,t.add_grad(s,r,p,_)}},e.prototype.toJSON=function(){var i=t.prototype.toJSON.call(this);return i.k=this.k,i.n=this.n,i.alpha=this.alpha,i.beta=this.beta,i},e.prototype.fromJSON=function(i){t.prototype.fromJSON.call(this,i),this.k=i.k,this.n=i.n,this.alpha=i.alpha,this.beta=i.beta},e}(t.BaseLayer);t.LocalResponseNormalizationLayer=e}(Net||(Net={}));var Net;!function(t){var i=function(i){function e(t,e){i.call(this),this.modelPath=t,this.weightPath=e}return __extends(e,i),e.prototype.load=function(){var t=this;return this.fetch(this.modelPath).then(function(i){return t.create(i)})},e.prototype.fetch=function(t){var i=new Parser.PrototxtParser;return i.parse(t)},e.prototype.create=function(t){this.name=t.name,this.createLayers(t,t.layer||t.layers,"data"===t.input),this.createEdges()},e.prototype.caffeLayerToJs=function(i){var e,s=this,r={name:i.name,input:i.bottom,output:i.top};switch(void 0!==i.bottom&&(Array.isArray(i.bottom)?r.pred=i.bottom.map(function(t){return s.layers.get(t)}):r.pred=this.layers.get(i.bottom)),i.type.toLowerCase()){case"input":var o=i.input_param||{};r.out_depth=+o.shape.dim[1],r.out_sx=+o.shape.dim[2],r.out_sy=+o.shape.dim[3],e=new t.InputLayer(r);break;case"conv":case"convolution":var o=i.param||{},n=i.convolution_param||{};r.sx=void 0!==n.kernel_size?+n.kernel_size:void 0,r.filters=void 0!==n.num_output?+n.num_output:void 0,r.pad=void 0!==n.pad?+n.pad:void 0,r.stride=void 0!==n.stride?+n.stride:void 0,r.l1_decay_mul=o&&o.length&&void 0!==o[0].decay_mult?+o[0].decay_mult:0,r.l2_decay_mul=o&&o.length&&void 0!==o[1].decay_mult?+o[1].decay_mult:1,e=new t.ConvLayer(r);break;case"lrn":var o=i.lrn_param||{};r.k=void 0!==o.k?+o.k:1,r.n=void 0!==r.local_size?+o.local_size:void 0,r.alpha=void 0!==o.alpha?+o.alpha:void 0,r.beta=void 0!==o.beta?+o.beta:void 0,e=new t.LocalResponseNormalizationLayer(r);break;case"dropout":var a=i.dropout_param||{};r.drop_prob=void 0!==a.dropout_ratio?+a.dropout_ratio:void 0,e=new t.DropoutLayer(r);break;case"concat":var n=i.concat_param||{};r.axis=void 0!==n.axis?+n.axis:void 0,e=new t.ConcatLayer(r);break;case"pool":case"pooling":var h=i.pooling_param||{};r.pool=void 0!==h.pool?h.pool:void 0,
r.sx=void 0!==h.kernel_size?+h.kernel_size:void 0,r.pad=void 0!==h.pad?+h.pad:void 0,r.stride=void 0!==h.stride?+h.stride:void 0,e=new t.PoolLayer(r);break;case"inner_product":case"innerproduct":var h=i.inner_product_param||{},o=i.param||{};r.num_neurons=void 0!==h.num_output?+h.num_output:void 0,r.l1_decay_mul=o&&o.length&&void 0!==o[0].decay_mult?+o[0].decay_mult:0,r.l2_decay_mul=o&&o.length&&void 0!==o[1].decay_mult?+o[1].decay_mult:1,e=new t.FullyConnectedLayer(r);break;case"softmax":e=new t.SoftmaxLayer(r);break;case"relu":e=new t.ReluLayer(r);break;case"sigmoid":e=new t.SigmoidLayer(r);break;case"tanh":e=new t.TanhLayer(r);break;default:return void console.error("Cannot parse layer "+i.type,i)}this.layers.set(e.name,e)},e.prototype.createLayers=function(i,e,s){var r=this;void 0===s&&(s=!1),this.layers=d3.map(),s&&this.layers.set("data",new t.InputLayer({name:"data",in_depth:+i.input_dim[1],in_sy:+i.input_dim[2],in_sx:+i.input_dim[3]})),e.forEach(function(t){return r.caffeLayerToJs(t)})},e.prototype.createEdges=function(){var t=this;this.edges=[],this.layers.values().filter(function(t){return void 0!==t.input&&t.input!==t.output}).forEach(function(i){Array.isArray(i.input)?i.input.forEach(function(e){t.edges.push({from:e,to:i.output})}):t.edges.push({from:i.input,to:i.output})}),this.layers.values().filter(function(t){return void 0!==t.input&&t.input===t.output}).forEach(function(i){t.edges.filter(function(t){return t.from===i.input}).forEach(function(e){e.from=i.name,t.edges.push({from:i.input,to:i.name})})})},e}(t.Net);t.CaffeModel=i}(Net||(Net={}));var Utils;!function(t){var i=function(t){function i(){t.call(this)}return __extends(i,t),i.prototype.render=function(t,i){void 0===i&&(i=600);var e=new dagreD3.render,s=this.createGraph(),r=d3.select(t);r.selectAll("*").remove();var o=r.append("svg").attr("width",i),n=o.append("g");e(n,s);var a=(i-s.graph().width)/2;n.attr("transform","translate("+a+", 20)"),o.attr("height",s.graph().height+40)},i.prototype.createGraph=function(){var t=this,i=(new dagreD3.graphlib.Graph).setGraph({}).setDefaultEdgeLabel(function(){return{}});return this.layerIterator(function(t,e,s){i.setNode(t.name,{labelType:"html",label:t.getDescription().join("<br>"),"class":"layer-"+t.layer_type})}),i.nodes().forEach(function(t){var e=i.node(t);e.rx=e.ry=5}),this.edges.filter(function(t){return void 0!==t.from&&void 0!==t.to}).forEach(function(e){i.setEdge(e.from,e.to,{label:t.layers.get(e.from).getOutputShape().join("x")})}),i},i.fromNet=function(t){var e=new i;return e.layers=t.layers,e.edges=t.edges,e},i}(Net.Net);t.GraphDrawer=i}(Utils||(Utils={}));